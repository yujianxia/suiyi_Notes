#
# éœ€æ±‚åˆ†æ

åœºæ™¯ä¸€ï¼š

<a data-fancybox title="demo" href="/notes/assets/react/81a080864616489cba0372f49d5730ad_tplv-k3u1fbpfcp-watermark.image">![demo](/notes/assets/react/81a080864616489cba0372f49d5730ad_tplv-k3u1fbpfcp-watermark.image)</a>

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå½“åœ¨æ•°ä¸‡çº§åˆ«çš„æ•°æ®ä¸­ï¼Œé€‰æ‹©ä¸€æ¡ï¼Œç‚¹å‡»**æŸ¥çœ‹**ï¼Œè·³è½¬åˆ°å½“å‰æ•°æ®çš„è¯¦æƒ…é¡µï¼Œå½“ç‚¹å‡»æŒ‰é’®**è¿”å›**è¿”å›æ¥ï¼Œæˆ–è€…æ˜¯æµè§ˆå™¨å‰è¿›åé€€ç­‰å…¶ä»–æ“ä½œï¼Œè¿”å›åˆ°åˆ—è¡¨é¡µçš„æ—¶å€™ã€‚è¦è®°å½•å½“å‰åˆ—è¡¨çš„ä½ç½®ã€‚ä¹Ÿå°±æ˜¯è¦è¿˜åŸç‚¹å‡»æŸ¥çœ‹**æŸ¥çœ‹**å‰çš„é¡µé¢ã€‚ä½†æ˜¯å½“ç‚¹å‡»tabèœå•æŒ‰é’®çš„æ—¶å€™ï¼Œè¦æ¸…é™¤é¡µé¢ä¿¡æ¯ã€‚

åœºæ™¯äºŒï¼š

<a data-fancybox title="demo" href="/notes/assets/react/d23019cf79d347a4b3f3e02352f1c971_tplv-k3u1fbpfcp-watermark.image">![demo](/notes/assets/react/d23019cf79d347a4b3f3e02352f1c971_tplv-k3u1fbpfcp-watermark.image)</a>

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå½“ç¼–è¾‘å†…å®¹çš„æ—¶å€™ï¼Œä¸€äº›æ•°æ®å¯èƒ½ä»å…¶ä»–é¡µé¢è·å¾—ï¼Œæ‰€ä»¥è¦æ±‚ï¼Œæ— è®ºåˆ‡æ¢è·¯ç”±ï¼Œåˆ‡æ¢é¡µé¢ï¼Œå½“å‰é¡µé¢çš„ç¼–è¾‘ä¿¡æ¯å‡ä¸èƒ½è¢«ç½®ç©ºï¼Œåªæœ‰ç‚¹å‡»**ç¡®å®š** ï¼Œ**é‡ç½®**ï¼Œè¡¨å•æ‰å†…å®¹ç½®ç©ºã€‚

åœºæ™¯ä¸‰ï¼š 

åœºæ™¯ä¸€ + åœºæ™¯äºŒ æ˜¯æ›´å¤æ‚çš„ç¼“å­˜é¡µé¢ä¿¡æ¯åœºæ™¯ã€‚

# äºŒ æ¢³ç†éœ€æ±‚

## 1 è§£å†³æ–¹æ¡ˆ

### 1 æ•°æ®çŠ¶æ€ç¼“å­˜åˆ°å…¬å…±ç®¡ç†å¯è¡Œæ€§

è¿™ä¸ªéœ€æ±‚é¦–å…ˆè®©æƒ³åˆ°çš„æ˜¯ç”¨`redux`æˆ–è€…æ˜¯`mobx`æ¥æŠŠé¡µé¢çš„çŠ¶æ€ç¼“å­˜èµ·æ¥ï¼Œç„¶ååˆ‡æ¢é¡µé¢çš„æ—¶å€™ï¼ŒæŠŠè¿™äº›æ•°æ®ç¼“å­˜è¿›å»ï¼Œå†æ¬¡åˆ‡æ¢å›æ¥çš„æ—¶å€™ï¼Œå°†æ•°æ®å–å‡ºæ¥ï¼Œè¿™æ ·å°±ä¸€ä¸ªé—®é¢˜ï¼Œå³ä¾¿èƒ½ç¼“å­˜`state`å±‚ï¼Œä½†æ˜¯å¦‚æœä¸€äº›è¡¨å•ç»„ä»¶æ˜¯éå—æ§ç»„ä»¶ï¼Œæ˜¯æ— æ³•ç¼“å­˜ä¸‹æ¥çš„ï¼Œè¿˜æœ‰ä¸€äº›`dom`çŠ¶æ€æ˜¯ç¼“å­˜ä¸äº†çš„ï¼Œæ¯”å¦‚æ‰‹åŠ¨æ·»åŠ çš„ä¸€äº›æ ·å¼ç­‰ã€‚è¿˜æœ‰å°±æ˜¯å®é™…æƒ…å†µæ¯”è¾ƒå¤æ‚ï¼Œæœ‰å¯Œæ–‡æœ¬ç»„ä»¶ï¼Œä½ æ˜¯æ— æ³•ç›´æ¥è·å–ç»‘å®šçš„`state`çš„ã€‚

ç¬¬äºŒä¸ªåŸå› å°±æ˜¯æœ‰å¥½å‡ ä¸ªé¡¹ç›®ï¼Œè€Œä¸”é¡µé¢æ¯”è¾ƒå¤šï¼Œå¦‚æœéƒ½å»ºç«‹æ•°æ®ç®¡ç†ï¼Œé‚£ä¹ˆå·¥ä½œé‡ä¼šéå¸¸çš„å¤§ã€‚

æ‰€ä»¥æ•°æ®çŠ¶æ€ç¼“å­˜çš„å¯è¡Œæ€§ä¸é«˜ï¼Œå³ä¾¿å¯ä»¥å®ç°ï¼Œä¹Ÿéœ€è¦å¤§é‡çš„å¤åˆ¶ç²˜è´´ï¼Œè¿™ä¸æ˜¯çš„è¿½æ±‚ã€‚

### 2 react-keepalive-routerè¯ç”Ÿ

å¯¹`Route` å’Œ `Switch` ç»„ä»¶åšä¸€äº›åŠŸèƒ½æ€§çš„æ‹“å±•

# ä¸‰è®¾è®¡é˜¶æ®µ
---

## 1 äº†è§£react-fiber

ä¸ºä»€ä¹ˆçš„é¡¹ç›®è¦æåˆ°`react-fiber`å‘¢ï¼Œè¿™é‡Œå…ˆè¯´ä¸€ä¸‹ï¼Œ`react-fiber`ï¼Œ `React Fiber` æ˜¯ä» v16 ç‰ˆæœ¬å¼€å§‹å¯¹ `Stack Reconciler` è¿›è¡Œçš„é‡å†™ï¼Œæ˜¯ v16 ç‰ˆæœ¬çš„æ ¸å¿ƒç®—æ³•å®ç°ã€‚`react`åœ¨åˆå§‹åŒ–æ„å»ºè¿‡ç¨‹ä¸­ï¼Œä¼šäº§ç”Ÿä¸€ä¸ªç”±`child`æŒ‡å‘å­`fiber`,`sibling`æŒ‡å‘å…„å¼Ÿ`fiber`,`return`æŒ‡å‘çˆ¶`fiber`ä¸‰ä¸ªæŒ‡é’ˆæ„å»ºçš„`fiber`æ ‘ç»“æ„ï¼Œé‡Œé¢ä¿å­˜ç€`dom`ä¿¡æ¯ï¼Œ`update`ä¿¡æ¯ï¼Œ`props`ä¿¡æ¯ç­‰ï¼Œæ ¸å¿ƒæ€æƒ³å°±æ˜¯ï¼Œåœ¨åˆ‡æ¢é¡µé¢çš„æ—¶å€™,ç»„ä»¶é”€æ¯ï¼Œä½†æ˜¯ä½œä¸ºæ¸²æŸ“è°ƒåº¦çš„`react fiber`ä¿å­˜`keepalive`çŠ¶æ€ã€‚åªè¦`fiber`å­˜æ´»ï¼Œå°±èƒ½è·å–åˆ°`dom`å…ƒç´ ï¼Œæ•°æ®å±‚`state`ç­‰ä¿¡æ¯ã€‚

<a data-fancybox title="demo" href="/notes/assets/react/7e28dff7b51a4c8ea54631be0e796904_tplv-k3u1fbpfcp-watermark.image">![demo](/notes/assets/react/7e28dff7b51a4c8ea54631be0e796904_tplv-k3u1fbpfcp-watermark.image)</a>

## 2 åŸºäº react-router-dom å’Œ react 16.8

é¦–å…ˆéœ€è¦å¯¹`react-router`åº“ä¸­çš„ `Route`ç»„ä»¶å’Œ`Switch`ç»„ä»¶ä½œå‡ºæ”¹é€ ï¼Œå¯ä»¥é€šè¿‡è·¯ç”±å±‚é¢å®ç°ç¼“å­˜è·¯ç”±åŠŸèƒ½ã€‚å› ä¸ºåœ¨è®¾è®¡ä¹‹åˆï¼Œå°±æƒ³ç€å°†ç”¨ä¸åŒçš„çŠ¶æ€ç®¡ç†`keepalive`çŠ¶æ€ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯ï¼Œåç»­å¯ä»¥ç»™ç¼“å­˜è·¯ç”±ç»„ä»¶ï¼Œå¢åŠ ä¸€äº›é¢å¤–çš„å£°æ˜å‘¨æœŸï¼Œæ¯”å¦‚è¯´`vue`ä¸­ `activated` å’Œ `deactivated`ä¸€æ ·ã€‚å› ä¸ºè®¾è®¡æ€æƒ³æ˜¯çŠ¶æ€ç®¡ç†ï¼Œé¡¹ç›®ä¾èµ–ä¸­ä¸æƒ³å¼•å…¥`redux`ç­‰ç¬¬ä¸‰æ–¹åº“ï¼Œæ‰€ä»¥è¿™é‡Œé€‰äº†`react-hooks`ä¸­ `useReducer`æ°åˆ°å¥½å¤„ã€‚è¿™å°±æ˜¯`react`åŸºç¡€åº“ `16.8+`çš„åŸå› ä¹‹ä¸€ã€‚å¦å¤–ä¸€ä¸ªåŸå› å°±æ˜¯`hooks`ä¸­æœ‰`useMemo`è¿™æ ·é˜²æ­¢æ¸²æŸ“ç©¿é€çš„api,æœ‰åŠ©äºè°ƒèŠ‚è·¯ç”±ç»„ä»¶çš„æ›´æ–°æ¬¡æ•°ã€‚

## å·¥ä½œæµç¨‹åˆ†æ

å—åˆ°`react-router-cache-route`å¼€æºé¡¹ç›®çš„å¯å‘ï¼Œåœ¨è®¾è®¡æ•´ä¸ªæµç¨‹çš„æ—¶å€™ï¼Œé‡‡å–äº†**äº¤æ¢`dom`æ ‘**çš„æ–¹å¼ã€‚

### åˆå§‹åŒ–ï¼š 

æ•´ä½“è®¾è®¡æ€è·¯ç¬¬ä¸€æ¬¡åˆ‡å…¥ç¼“å­˜é¡µé¢çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªå®¹å™¨ç»„ä»¶ï¼Œç¼“å­˜`Route`ä¼šæŠŠç»„ä»¶ï¼Œäº¤ç»™å®¹å™¨ç»„ä»¶æ¥æŒ‚è½½ï¼Œç„¶åå®¹å™¨ç»„ä»¶ç”Ÿæˆ`fiber`,`render`ä¹‹åç”Ÿæˆå¯¹åº”çš„`dom`æ ‘ï¼Œå°†`dom`æ ‘äº¤ç»™`Route`ç»„ä»¶ï¼ˆä¹Ÿå°±æ˜¯çš„æ­£å¸¸çš„é¡µé¢ï¼‰ã€‚

### åˆ‡æ¢é¡µé¢ï¼š

åˆ‡æ¢é¡µé¢çš„æ—¶å€™ï¼Œè·¯ç”±ç»„ä»¶æ˜¯è‚¯å®šå¸è½½çš„ï¼Œè¿™æ—¶å€™éœ€è¦å°†çš„`dom`è¿˜ç»™å®¹å™¨ç»„ä»¶ï¼Œç„¶åå®¹å™¨ç»„ä»¶è¿›å…¥å†»ç»“çŠ¶æ€ã€‚

### å†æ¬¡åˆ‡æ¢åˆ°ç¼“å­˜é¡µé¢ï¼š

å†æ¬¡è¿›å…¥è·¯ç”±é¡µé¢çš„æ—¶å€™,é¦–å…ˆä»å®¹å™¨ä¸­ï¼Œå‘ç°æœ‰è¯¥é¡µé¢çš„ç¼“å­˜ï¼Œé‚£ä¹ˆå°†å®¹å™¨è§£å°çŠ¶æ€ï¼Œç„¶åå°†`dom`æ ‘ï¼Œè¿˜ç»™å½“å‰è·¯ç”±é¡µé¢ã€‚å®Œæˆ`keepalive`çŠ¶æ€ã€‚

### ç¼“å­˜é”€æ¯ï¼š

é¡¹ç›®æ”¯æŒé”€æ¯ç¼“å­˜åŠŸèƒ½ï¼Œè°ƒç”¨é”€æ¯æ–¹æ³•,ä¼šå¸è½½å½“å‰ç¼“å­˜å®¹å™¨ï¼Œè¿›ä¸€æ­¥é”€æ¯`fiber` å’Œ `dom` ï¼Œå®Œæˆæ•´ä¸ªé”€æ¯åŠŸèƒ½ã€‚

### å·¥ä½œæµç¨‹å›¾

<a data-fancybox title="demo" href="/notes/assets/react/d8984d3899644b86bf9ecb3f4e5324e1_tplv-k3u1fbpfcp-watermark.image">![demo](/notes/assets/react/d8984d3899644b86bf9ecb3f4e5324e1_tplv-k3u1fbpfcp-watermark.image)</a>

## å·¥ä½œåŸç†å›¾

<a data-fancybox title="demo" href="/notes/assets/react/2d85d06f66fe4c009c6e9c45b75e045f_tplv-k3u1fbpfcp-watermark.image">![demo](/notes/assets/react/2d85d06f66fe4c009c6e9c45b75e045f_tplv-k3u1fbpfcp-watermark.image)</a>

## è®¾è®¡çš„ä¼˜åŠ¿

1. å› ä¸ºå†…éƒ¨è¿ç”¨äº† `useReducer` çŠ¶æ€ç®¡ç†ï¼Œç®¡ç†ç¼“å­˜çŠ¶æ€ï¼Œå¯ä»¥æ›´çµæ´»ï¼Œæ“çºµç¼“å­˜è·¯ç”±ç»„ä»¶ï¼Œé‡‡ç”¨`react hooks`å…¨æ–°`api`,æ¸²æŸ“èŠ‚æµï¼Œæ‰‹åŠ¨è§£é™¤ç¼“å­˜ï¼Œå¢åŠ äº†ç¼“å­˜çš„çŠ¶æ€å‘¨æœŸï¼Œç›‘å¬å‡½æ•°ç­‰ã€‚

2. è¿™å¥—ç¼“å­˜é¡µé¢çš„æ€æƒ³ï¼Œä¸ä»…ä»…å¯ä»¥ç”¨åœ¨è·¯ç”±é¡µé¢çº§åˆ«ï¼ŒåæœŸå¯ä»¥è¿ç§»çš„`component`ç»„ä»¶çº§åˆ«ä¸Šæ¥ã€‚ä¹Ÿæ˜¯åç»­ç»´æŠ¤å’Œå¼€å‘çš„æ–¹å‘ã€‚

# å›› ä½¿ç”¨ç®€ä»‹ + å¿«é€Ÿä¸Šæ‰‹
---

## ä¸‹è½½

å› ä¸ºæ˜¯æŠŠé¡¹ç›®ä¸Šä¼ åˆ°äº†`npm`æ–¹ä¾¿å…¶ä»–é¡¹ç›®ç”¨ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ä» `npm` ä¸Šä¸‹è½½ã€‚

```shell
npm install react-keepalive-router --save
# or
yarn add react-keepalive-router
```

## 1 åŸºæœ¬ç”¨æ³•

### KeepaliveRouterSwitch

`KeepaliveRouterSwitch`å¯ä»¥ç†è§£ä¸ºå¸¸è§„çš„Switch,ä¹Ÿå¯ä»¥ç†è§£ä¸º `keepaliveScope`,**ç¡®ä¿æ•´ä¸ªç¼“å­˜ä½œç”¨åŸŸï¼Œåªæœ‰ä¸€ä¸ª `KeepaliveRouterSwitch` å°±å¯ä»¥äº†ã€‚**

### å¸¸è§„ç”¨æ³•

```js
import { BrowserRouter as Router, Route, Redirect ,useHistory  } from 'react-router-dom'
import { KeepaliveRouterSwitch ,KeepaliveRoute ,addKeeperListener } from 'react-keepalive-router'

const index = () => {
  useEffect(()=>{
    /* å¢åŠ ç¼“å­˜ç›‘å¬å™¨ */
    addKeeperListener((history,cacheKey)=>{
      if(history)console.log('å½“å‰æ¿€æ´»çŠ¶æ€ç¼“å­˜ç»„ä»¶ï¼š'+ cacheKey )
    })
  },[])
  return <div >
    <div >
      <Router  >
      <Meuns/>
      <KeepaliveRouterSwitch>
          <Route path={'/index'} component={Index} ></Route>
          <Route path={'/list'} component={List} ></Route>
          { /* å°†è¯¦æƒ…é¡µåŠ å…¥ç¼“å­˜ */ }
          <KeepaliveRoute path={'/detail'} component={ Detail } ></KeepaliveRoute>
          <Redirect from='/*' to='/index' />
       </KeepaliveRouterSwitch>
      </Router>
    </div>
  </div>
}
```

è¿™é‡Œåº”è¯¥æ³¨æ„âš ï¸çš„æ˜¯å¯¹äºå¤æ‚çš„è·¯ç”±ç»“æ„ã€‚æˆ–è€…`KeepaliveRouterSwitch` åŒ…è£¹çš„å­ç»„ä»¶ä¸æ˜¯`Route` ,è¦ç»™ `KeepaliveRouterSwitch` å¢åŠ ç‰¹æœ‰çš„å±æ€§ `withoutRoute` å°±å¯ä»¥äº†ã€‚å¦‚ä¸‹ä¾‹å­ğŸŒ°ğŸŒ°ğŸŒ°ï¼š

**ä¾‹å­ä¸€**

```jsx
<KeepaliveRouterSwitch withoutRoute >
  <div>
     <Route path="/a" component={ComponentA}  />
     <Route path="/b" component={ComponentB}  />
     <KeepaliveRoute path={'/detail'} component={ Detail } ></KeepaliveRoute>
  </div>
</KeepaliveRouterSwitch>
```

**ä¾‹å­äºŒ**

æˆ–è€…å¯ä»¥ä½¿ç”¨ `renderRoutes` ç­‰`api`é…åˆ `KeepliveRouterSwitch` ä½¿ç”¨ ã€‚

```jsx
import {renderRoutes} from "react-router-config"
<KeepliveRouterSwitch withoutRoute  >{ renderRoutes(routes) }</KeepliveRouterSwitch> 
```

### KeepaliveRoute

`KeepaliveRoute` åŸºæœ¬ä½¿ç”¨å’Œ `Route`æ²¡æœ‰ä»»ä½•åŒºåˆ«ã€‚

**åœ¨å½“å‰ç‰ˆæœ¬ä¸­âš ï¸âš ï¸âš ï¸å¦‚æœ `KeepaliveRoute` å¦‚æœæ²¡æœ‰è¢« `KeepaliveRouterSwitch`åŒ…è£¹å°±ä¼šå¤±å»ç¼“å­˜ä½œç”¨ã€‚**

**æ•ˆæœ**

<a data-fancybox title="demo" href="/notes/assets/react/d29a133700134541b8bc0586e8951ab4_tplv-k3u1fbpfcp-watermark.image">![demo](/notes/assets/react/d29a133700134541b8bc0586e8951ab4_tplv-k3u1fbpfcp-watermark.image)</a>

## 2 å…¶ä»–åŠŸèƒ½

### 1 ç¼“å­˜ç»„ä»¶æ¿€æ´»ç›‘å¬å™¨

å¦‚æœå¸Œæœ›å¯¹å½“å‰æ¿€æ´»çš„ç»„ä»¶ï¼Œæœ‰ä¸€äº›é¢å¤–çš„æ“ä½œï¼Œå¯ä»¥æ·»åŠ ç›‘å¬å™¨ï¼Œç”¨æ¥ç›‘å¬ç¼“å­˜ç»„ä»¶çš„æ¿€æ´»çŠ¶æ€ã€‚

```jsx
addKeeperListener((history,cacheKey)=>{
  if(history)console.log('å½“å‰æ¿€æ´»çŠ¶æ€ç¼“å­˜ç»„ä»¶ï¼š'+ cacheKey )
})
```

ç¬¬ä¸€ä¸ªå‚æ•°æœª`history`å¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºå½“å‰ç¼“å­˜è·¯ç”±çš„å”¯ä¸€æ ‡è¯†`cacheKey`

### 2 æ¸…é™¤ç¼“å­˜

ç¼“å­˜çš„ç»„ä»¶ï¼Œæˆ–æ˜¯è¢«`route`åŒ…è£¹çš„ç»„ä»¶ï¼Œä¼šåœ¨`props`å¢åŠ é¢å¤–çš„æ–¹æ³•`cacheDispatch`ç”¨æ¥æ¸…é™¤ç¼“å­˜ã€‚

å¦‚æœ`props`æ²¡æœ‰`cacheDispatch`æ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡

```jsx
import React from 'react'
import { useCacheDispatch } from 'react-keepalive-router'

function index(){
    const cacheDispatch = useCacheDispatch()
    return <div>æ˜¯é¦–é¡µ
        <button onClick={()=> cacheDispatch({ type:'reset' }) } >æ¸…é™¤ç¼“å­˜</button>
    </div>
}

export default index
```

1. æ¸…é™¤æ‰€æœ‰ç¼“å­˜

```js
cacheDispatch({ type:'reset' })
```

2. æ¸…é™¤å•ä¸ªç¼“å­˜

```js
cacheDispatch({ type:'reset',payload:'cacheId' })
```

3. æ¸…é™¤å¤šä¸ªç¼“å­˜

```js
cacheDispatch({ type:'reset',payload:['cacheId1'ï¼Œ'cacheId2'] })
```

# äº” éªŒè¯é˜¶æ®µ

ç¬¬ä¸€ä¸ªéœ€æ±‚ï¼š

<a data-fancybox title="demo" href="/notes/assets/react/8f4cfd3824314a36b71c26f76e7549d4_tplv-k3u1fbpfcp-watermark.image">![demo](/notes/assets/react/8f4cfd3824314a36b71c26f76e7549d4_tplv-k3u1fbpfcp-watermark.image)</a>

ç¬¬äºŒä¸ªéœ€æ±‚:

<a data-fancybox title="demo" href="/notes/assets/react/fabcfb104f6443d991db06b764369bf9_tplv-k3u1fbpfcp-watermark.image">![demo](/notes/assets/react/fabcfb104f6443d991db06b764369bf9_tplv-k3u1fbpfcp-watermark.image)</a>

# å…­ æ‰“åŒ…é˜¶æ®µ + å‘å¸ƒnpmé˜¶æ®µ

## rollupæ‰“åŒ…

æ¥ä¸‹æ¥å°±æ˜¯ `rollup` æ‰“åŒ…é˜¶æ®µï¼Œ`rollup`æ‰“åŒ…é˜¶æ®µã€‚é¡¹ç›®ç»“æ„æ˜¯è¿™æ ·çš„ã€‚

<a data-fancybox title="demo" href="/notes/assets/react/153608040d3d4fc7b520fd65c6fa3aa1_tplv-k3u1fbpfcp-watermark.image">![demo](/notes/assets/react/153608040d3d4fc7b520fd65c6fa3aa1_tplv-k3u1fbpfcp-watermark.image)</a>

`rollup.config.js`æ˜¯æ•´ä¸ª`rollup`çš„é…ç½®æ–‡ä»¶ï¼Œç„¶åé€šè¿‡ `rollup` æ‰“åŒ…åçš„æ–‡ä»¶å­˜åœ¨ `lib`æ–‡ä»¶å¤¹ä¸‹ã€‚

<a data-fancybox title="demo" href="/notes/assets/react/1d705258f2654d9188516f6d15a1233c_tplv-k3u1fbpfcp-watermark.image">![demo](/notes/assets/react/1d705258f2654d9188516f6d15a1233c_tplv-k3u1fbpfcp-watermark.image)</a>

`rollup.config.js` å†…å®¹å¦‚ä¸‹

```js
import resolve from 'rollup-plugin-node-resolve'
import babel from 'rollup-plugin-babel'
import { uglify } from 'rollup-plugin-uglify'

export default [
    {
      input: 'src/index.js',
      output: {
        name: 'keepaliveRouter',
        file: 'lib/index.js',
        format: 'cjs',
        sourcemap: true
      },
      external: [
        'react',
        'react-router-dom',
        'invariant'
      ],
      plugins: [
        resolve(),
        babel({
          exclude: 'node_modules/**'
        })
      ]
    },
    /* å‹ç¼©` */
    {
      input: 'src/index.js',
      output: {
        name: 'keepaliveRouter',
        file: 'lib/index.min.js',
        format: 'umd'
      },
      external: [
        'react',
        'react-router-dom',
        'invariant'
      ],
      plugins: [
        resolve(),
        babel({
          exclude: 'node_modules/**'
        }),
        uglify()
      ]
    }
]
```

## å‘å¸ƒnpm

å¯¹äºå‘å¸ƒnpm

ç¬¬ä¸€æ­¥ï¼šéœ€è¦åœ¨`npm`æ³¨å†Œè´¦å·ã€‚`https://www.npmjs.com/signup`

ç¬¬äºŒæ­¥ï¼š ç™»é™† `npm login`

ç¬¬ä¸‰æ­¥ï¼šåˆ›å»º `package.json`

```json
{
  "name": "react-keepalive-router", /* åç§° */
  "version": "1.1.0",  /* ç‰ˆæœ¬å· */
  "description": "åŸºäº`react 16.8+` ,`react-router 4+` å¼€å‘çš„`react`ç¼“å­˜ç»„ä»¶ï¼Œå¯ä»¥ç”¨äºç¼“å­˜é¡µé¢ç»„ä»¶ï¼Œç±»ä¼¼`vue`çš„`keepalive`åŒ…è£¹`vue-router`çš„æ•ˆæœåŠŸèƒ½ã€‚", /* æè¿° */
  "main": "index.js", /* å…¥å£æ–‡ä»¶ */
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1",
    "build": "rollup --config"
  },
  "keywords": [  /* npm å…³é”®è¯ */
    "keep alive",
    "react",
    "react router",
    "react keep alive route",
    "react hooks"
  ],
  "homepage": "https://github.com/GoodLuckAlien/react-keepalive-router", /* æŒ‡å‘ github  */
  "peerDependencies": { /* npm é¡¹ç›®ä¾èµ– */
    "react": ">=16.8",
    "react-router-dom": ">=4",
    "invariant": ">=2"
  },
  "author": "alien",
  "license": "ISC",
  "devDependencies": {  /* å¼€å‘ç¯å¢ƒä¸‹ä¾èµ– */
    "@babel/core": "^7.12.3",
    "@babel/preset-react": "^7.12.5",
    "@babel/preset-env": "^7.12.1",
    "@babel/plugin-proposal-class-properties": "^7.12.1",
    "rollup": "^2.33.3",
    "rollup-plugin-node-resolve": "^5.2.0",
    "rollup-plugin-babel": "^4.4.0",
    "rollup-plugin-uglify": "^6.0.4"
  },
  "dependencies": { /* ç”Ÿäº§ç¯å¢ƒä¾èµ– */
    "invariant": "^2.2.4"
  }
}
```

ç¬¬å››æ­¥ï¼šä¸‡äº‹ä¿±å¤‡ä¹‹åï¼Œç”¨ `npm publish` å‘å¸ƒã€‚

ç¬¬äº”æ­¥ï¼šå‡çº§ç‰ˆæœ¬ï¼Œå‡çº§ç‰ˆæœ¬å¾ˆç®€å•ï¼Œéœ€è¦åœ¨`package.json` å‡çº§ç‰ˆæœ¬å·ï¼Œç„¶åé‡æ–° `npm publish` å°±å¯ä»¥äº†ã€‚

**åºŸå¼ƒç‰ˆæœ¬å·**

å¦‚æœæƒ³åºŸå¼ƒæŸä¸ªç‰ˆæœ¬ , æ‰§è¡Œå‘½ä»¤ `npm deprecate <pkg>[@<version>] <message>`

**åºŸå¼ƒåŒ…**

å¦‚æœæƒ³åºŸå¼ƒåŒ… `npm unpublish <pkg> --force`

**`.npmignore`**

`.npmignore`é‡Œé¢å£°æ˜çš„æ–‡ä»¶å’Œæ–‡ä»¶ä»·åç§°ï¼Œä¸ä¼šè¢«ä¸Šä¼ åˆ° `npm` , çš„é¡¹ç›®é™¤äº† `README.md` ,`package.json` å’Œ `lib`   ä¸‹æ‰“åŒ…çš„æ–‡ä»¶ä¹‹å¤–ï¼Œå¤§éƒ¨åˆ†æ–‡ä»¶æ˜¯å¼€å‘æ—¶å€™æˆ–è€…ç¼–è¯‘é˜¶æ®µç”¨åˆ°çš„ï¼Œä¸éœ€è¦ä¸Šä¼ åˆ°`npm`ï¼Œæ‰€ä»¥éœ€è¦åœ¨ `.npmignore` è¿™ä¹ˆå†™

```js
docs
node_modules
src
md
.babelrc
.gitignore
.npmignore
.prettierrc
rollup.config.js
yarn.lock
```

[react-keepalive-router](https://github.com/GoodLuckAlien/react-keepalive-router)