(window.webpackJsonp=window.webpackJsonp||[]).push([[282],{642:function(s,a,t){"use strict";t.r(a);var e=t(25),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("上一节提到"),t("code",[s._v("Scheduler")]),s._v("与"),t("code",[s._v("React")]),s._v("是两套"),t("code",[s._v("优先级")]),s._v("机制。在"),t("code",[s._v("React")]),s._v("中，存在多种使用不同"),t("code",[s._v("优先级")]),s._v("的情况，比如：")]),s._v(" "),t("p",[s._v("注：以下例子皆为"),t("code",[s._v("Concurrent Mode")]),s._v("开启情况")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("过期任务或者同步任务使用"),t("code",[s._v("同步")]),s._v("优先级")])]),s._v(" "),t("li",[t("p",[s._v("用户交互产生的更新（比如点击事件）使用高优先级")])]),s._v(" "),t("li",[t("p",[s._v("网络请求产生的更新使用一般优先级")])]),s._v(" "),t("li",[t("p",[t("code",[s._v("Suspense")]),s._v("使用低优先级")])])]),s._v(" "),t("p",[t("code",[s._v("React")]),s._v("需要设计一套满足如下需要的"),t("code",[s._v("优先级")]),s._v("机制：")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("可以表示"),t("code",[s._v("优先级")]),s._v("的不同")])]),s._v(" "),t("li",[t("p",[s._v("可能同时存在几个同"),t("code",[s._v("优先级")]),s._v("的"),t("code",[s._v("更新")]),s._v("，所以还得能表示"),t("code",[s._v("批")]),s._v("的概念")])]),s._v(" "),t("li",[t("p",[s._v("方便进行"),t("code",[s._v("优先级")]),s._v("相关计算")])])]),s._v(" "),t("p",[s._v("为了满足如上需求，"),t("code",[s._v("React")]),s._v("设计了"),t("code",[s._v("lane")]),s._v("模型。接下来来看"),t("code",[s._v("lane")]),s._v("模型如何满足以上3个条件。")]),s._v(" "),t("h2",{attrs:{id:"表示优先级的不同"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#表示优先级的不同"}},[s._v("#")]),s._v(" 表示优先级的不同")]),s._v(" "),t("p",[s._v("想象你身处赛车场。")]),s._v(" "),t("p",[t("a",{attrs:{"data-fancybox":"",title:"30sec",href:"/notes/assets/react/lane.jpeg"}},[t("img",{attrs:{src:"/notes/assets/react/lane.jpeg",alt:"30sec"}})])]),s._v(" "),t("p",[s._v("不同的赛车疾驰在不同的赛道。内圈的赛道总长度更短，外圈更长。某几个临近的赛道的长度可以看作差不多长。")]),s._v(" "),t("p",[t("code",[s._v("lane")]),s._v("模型借鉴了同样的概念，使用31位的二进制表示31条赛道，位数越小的赛道"),t("code",[s._v("优先级")]),s._v("越高，某些相邻的赛道拥有相同"),t("code",[s._v("优先级")]),s._v("。")]),s._v(" "),t("p",[s._v("如下：")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" NoLanes"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lanes "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*                        */")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0b0000000000000000000000000000000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" NoLane"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lane "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*                          */")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0b0000000000000000000000000000000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" SyncLane"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lane "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*                        */")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0b0000000000000000000000000000001")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" SyncBatchedLane"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lane "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*                 */")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0b0000000000000000000000000000010")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" InputDiscreteHydrationLane"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lane "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*      */")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0b0000000000000000000000000000100")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" InputDiscreteLanes"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lanes "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*                    */")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0b0000000000000000000000000011000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" InputContinuousHydrationLane"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lane "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*           */")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0b0000000000000000000000000100000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" InputContinuousLanes"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lanes "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*                  */")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0b0000000000000000000000011000000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" DefaultHydrationLane"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lane "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*            */")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0b0000000000000000000000100000000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" DefaultLanes"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lanes "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*                   */")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0b0000000000000000000111000000000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" TransitionHydrationLane"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lane "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*                */")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0b0000000000000000001000000000000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" TransitionLanes"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lanes "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*                       */")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0b0000000001111111110000000000000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" RetryLanes"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lanes "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*                            */")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0b0000011110000000000000000000000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" SomeRetryLane"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lanes "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*                  */")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0b0000010000000000000000000000000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" SelectiveHydrationLane"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lane "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*          */")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0b0000100000000000000000000000000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" NonIdleLanes "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*                                 */")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0b0000111111111111111111111111111")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" IdleHydrationLane"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lane "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*               */")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0b0001000000000000000000000000000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" IdleLanes"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lanes "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*                             */")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0b0110000000000000000000000000000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" OffscreenLane"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lane "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*                   */")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0b1000000000000000000000000000000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br")])]),t("blockquote",[t("p",[s._v("你可以在"),t("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberLane.js#L77-L107",target:"_blank",rel:"noopener noreferrer"}},[s._v("这里"),t("OutboundLink")],1),s._v("看到"),t("code",[s._v("lane")]),s._v("的定义")])]),s._v(" "),t("p",[s._v("其中，同步优先级占用的赛道为第一位：")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" SyncLane"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lane "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*                        */")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0b0000000000000000000000000000001")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("从"),t("code",[s._v("SyncLane")]),s._v("往下一直到"),t("code",[s._v("SelectiveHydrationLane")]),s._v("，赛道的"),t("code",[s._v("优先级")]),s._v("逐步降低。")]),s._v(" "),t("h2",{attrs:{id:"表示-批-的概念"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#表示-批-的概念"}},[s._v("#")]),s._v(" 表示“批”的概念")]),s._v(" "),t("p",[s._v("可以看到其中有几个变量占用了几条赛道，比如：")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" InputDiscreteLanes"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lanes "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*                    */")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0b0000000000000000000000000011000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" DefaultLanes"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lanes "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*                   */")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0b0000000000000000000111000000000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" TransitionLanes"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lanes "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*                       */")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0b0000000001111111110000000000000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("这就是"),t("code",[s._v("批")]),s._v("的概念，被称作"),t("code",[s._v("lanes")]),s._v("（区别于"),t("code",[s._v("优先级")]),s._v("的"),t("code",[s._v("lane")]),s._v("）。")]),s._v(" "),t("p",[s._v("其中"),t("code",[s._v("InputDiscreteLanes")]),s._v("是“用户交互”触发更新会拥有的"),t("code",[s._v("优先级")]),s._v("范围。")]),s._v(" "),t("p",[t("code",[s._v("DefaultLanes")]),s._v("是“请求数据返回后触发更新”拥有的"),t("code",[s._v("优先级")]),s._v("范围。")]),s._v(" "),t("p",[t("code",[s._v("TransitionLanes")]),s._v("是"),t("code",[s._v("Suspense")]),s._v("、"),t("code",[s._v("useTransition")]),s._v("、"),t("code",[s._v("useDeferredValue")]),s._v("拥有的"),t("code",[s._v("优先级")]),s._v("范围。")]),s._v(" "),t("p",[s._v("这其中有个细节，越低"),t("code",[s._v("优先级")]),s._v("的"),t("code",[s._v("lanes")]),s._v("占用的位越多。比如"),t("code",[s._v("InputDiscreteLanes")]),s._v("占了2个位，"),t("code",[s._v("TransitionLanes")]),s._v("占了9个位。")]),s._v(" "),t("p",[s._v("原因在于：越低"),t("code",[s._v("优先级")]),s._v("的"),t("code",[s._v("更新")]),s._v("越容易被打断，导致积压下来，所以需要更多的位。相反，最高优的同步更新的"),t("code",[s._v("SyncLane")]),s._v("不需要多余的"),t("code",[s._v("lanes")]),s._v("。")]),s._v(" "),t("h2",{attrs:{id:"方便进行优先级相关计算"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#方便进行优先级相关计算"}},[s._v("#")]),s._v(" 方便进行优先级相关计算")]),s._v(" "),t("p",[s._v("既然"),t("code",[s._v("lane")]),s._v("对应了二进制的位，那么"),t("code",[s._v("优先级")]),s._v("相关计算其实就是位运算。")]),s._v(" "),t("p",[s._v("比如：")]),s._v(" "),t("p",[s._v("计算"),t("code",[s._v("a")]),s._v("、"),t("code",[s._v("b")]),s._v("两个"),t("code",[s._v("lane")]),s._v("是否存在交集，只需要判断"),t("code",[s._v("a")]),s._v("与"),t("code",[s._v("b")]),s._v("按位与的结果是否为"),t("code",[s._v("0")]),s._v("：")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("includesSomeLane")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("a"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lanes "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Lane"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" b"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lanes "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Lane")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("a "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v(" b"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!==")]),s._v(" NoLanes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("计算"),t("code",[s._v("b")]),s._v("这个"),t("code",[s._v("lanes")]),s._v("是否是"),t("code",[s._v("a")]),s._v("对应的"),t("code",[s._v("lanes")]),s._v("的子集，只需要判断"),t("code",[s._v("a")]),s._v("与"),t("code",[s._v("b")]),s._v("按位与的结果是否为"),t("code",[s._v("b")]),s._v("：")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("isSubsetOfLanes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("set"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lanes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" subset"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lanes "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Lane")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("set "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v(" subset"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("===")]),s._v(" subset"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("将两个"),t("code",[s._v("lane")]),s._v("或"),t("code",[s._v("lanes")]),s._v("的位合并只需要执行按位或操作：")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mergeLanes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("a"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lanes "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Lane"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" b"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lanes "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Lane")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lanes "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" a "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" b"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("从"),t("code",[s._v("set")]),s._v("对应"),t("code",[s._v("lanes")]),s._v("中移除"),t("code",[s._v("subset")]),s._v("对应"),t("code",[s._v("lane")]),s._v("（或"),t("code",[s._v("lanes")]),s._v("），只需要对"),t("code",[s._v("subset")]),s._v("的"),t("code",[s._v("lane")]),s._v("（或"),t("code",[s._v("lanes")]),s._v("）执行按位非，结果再对"),t("code",[s._v("set")]),s._v("执行按位与。")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("removeLanes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("set"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lanes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" subset"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lanes "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Lane")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lanes "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" set "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("~")]),s._v("subset"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("blockquote",[t("p",[s._v("更多位运算参考"),t("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/Bitwise_Operators",target:"_blank",rel:"noopener noreferrer"}},[s._v("MDN"),t("OutboundLink")],1)])]),s._v(" "),t("h2",{attrs:{id:"总结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),t("p",[s._v("这就是"),t("code",[s._v("React")]),s._v("的优先级模型"),t("code",[s._v("lane")]),s._v("模型。")]),s._v(" "),t("p",[s._v("至此，已经了解"),t("code",[s._v("Fiber")]),s._v("架构、"),t("code",[s._v("更新")]),s._v("的"),t("code",[s._v("优先级")]),s._v("、"),t("code",[s._v("Scheduler")]),s._v("的实现、"),t("code",[s._v("lane")]),s._v("模型。从下一节开始，会逐步讲解"),t("code",[s._v("Concurrent Mode")]),s._v("的各种应用。")])])}),[],!1,null,null,null);a.default=n.exports}}]);