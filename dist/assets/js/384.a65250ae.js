(window.webpackJsonp=window.webpackJsonp||[]).push([[384],{744:function(e,t,a){"use strict";a.r(t);var s=a(25),r=Object(s.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("p",[e._v("通过"),a("RouterLink",{attrs:{to:"/react/state/mental.html"}},[e._v("更新的心智模型")]),e._v("，了解到"),a("code",[e._v("更新")]),e._v("具有"),a("code",[e._v("优先级")]),e._v("。")],1),e._v(" "),a("p",[e._v("那么什么是"),a("code",[e._v("优先级")]),e._v("？"),a("code",[e._v("优先级")]),e._v("以什么为依据？如何通过"),a("code",[e._v("优先级")]),e._v("决定哪个状态应该先被更新？")]),e._v(" "),a("p",[e._v("本节会详细讲解。")]),e._v(" "),a("h2",{attrs:{id:"什么是优先级"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#什么是优先级"}},[e._v("#")]),e._v(" 什么是优先级")]),e._v(" "),a("p",[e._v("在"),a("RouterLink",{attrs:{to:"/react/preparation/idea.html#理解-响应自然"}},[e._v("React理念一节")]),e._v("聊到"),a("code",[e._v("React")]),e._v("将人机交互研究的结果整合到真实的"),a("code",[e._v("UI")]),e._v("中。具体到"),a("code",[e._v("React")]),e._v("运行上这是什么意思呢？")],1),e._v(" "),a("p",[a("code",[e._v("状态更新")]),e._v("由"),a("code",[e._v("用户交互")]),e._v("产生，用户心里对"),a("code",[e._v("交互")]),e._v("执行顺序有个预期。"),a("code",[e._v("React")]),e._v("根据"),a("code",[e._v("人机交互研究的结果")]),e._v("中用户对"),a("code",[e._v("交互")]),e._v("的预期顺序为"),a("code",[e._v("交互")]),e._v("产生的"),a("code",[e._v("状态更新")]),e._v("赋予不同优先级。")]),e._v(" "),a("p",[e._v("具体如下：")]),e._v(" "),a("ul",[a("li",[a("p",[e._v("生命周期方法：同步执行。")])]),e._v(" "),a("li",[a("p",[e._v("受控的用户输入：比如输入框内输入文字，同步执行。")])]),e._v(" "),a("li",[a("p",[e._v("交互事件：比如动画，高优先级执行。")])]),e._v(" "),a("li",[a("p",[e._v("其他：比如数据请求，低优先级执行。")])])]),e._v(" "),a("h2",{attrs:{id:"如何调度优先级"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#如何调度优先级"}},[e._v("#")]),e._v(" 如何调度优先级")]),e._v(" "),a("p",[e._v("在"),a("RouterLink",{attrs:{to:"/react/preparation/newConstructure.html"}},[e._v("新的React结构一节")]),e._v("讲到，"),a("code",[e._v("React")]),e._v("通过"),a("code",[e._v("Scheduler")]),e._v("调度任务。")],1),e._v(" "),a("p",[e._v("具体到代码，每当需要调度任务时，"),a("code",[e._v("React")]),e._v("会调用"),a("code",[e._v("Scheduler")]),e._v("提供的方法"),a("code",[e._v("runWithPriority")]),e._v("。")]),e._v(" "),a("p",[e._v("该方法接收一个"),a("code",[e._v("优先级")]),e._v("常量与一个"),a("code",[e._v("回调函数")]),e._v("作为参数。"),a("code",[e._v("回调函数")]),e._v("会以"),a("code",[e._v("优先级")]),e._v("高低为顺序排列在一个"),a("code",[e._v("定时器")]),e._v("中并在合适的时间触发。")]),e._v(" "),a("p",[e._v("对于更新来讲，传递的"),a("code",[e._v("回调函数")]),e._v("一般为"),a("RouterLink",{attrs:{to:"/react/state/prepare.html#render阶段的开始"}},[e._v("状态更新流程概览一节")]),e._v("讲到的"),a("code",[e._v("render阶段的入口函数")]),e._v("。")],1),e._v(" "),a("blockquote",[a("p",[e._v("你可以在"),a("a",{attrs:{href:"https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/scheduler/src/Scheduler.js#L217",target:"_blank",rel:"noopener noreferrer"}},[e._v("==unstable_runWithPriority== 这里"),a("OutboundLink")],1),e._v("看到"),a("code",[e._v("runWithPriority")]),e._v("方法的定义。在"),a("a",{attrs:{href:"https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/scheduler/src/SchedulerPriorities.js",target:"_blank",rel:"noopener noreferrer"}},[e._v("这里"),a("OutboundLink")],1),e._v("看到"),a("code",[e._v("Scheduler")]),e._v("对优先级常量的定义。")])]),e._v(" "),a("h2",{attrs:{id:"例子"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#例子"}},[e._v("#")]),e._v(" 例子")]),e._v(" "),a("p",[e._v("优先级最终会反映到"),a("code",[e._v("update.lane")]),e._v("变量上。当前只需要知道这个变量能够区分"),a("code",[e._v("Update")]),e._v("的优先级。")]),e._v(" "),a("p",[e._v("接下来通过一个例子结合上一节介绍的"),a("code",[e._v("Update")]),e._v("相关字段讲解优先级如何决定更新的顺序。")]),e._v(" "),a("blockquote",[a("p",[e._v("该例子来自"),a("a",{attrs:{href:"https://twitter.com/acdlite/status/978412930973687808",target:"_blank",rel:"noopener noreferrer"}},[e._v("React Core Team Andrew向网友讲解Update工作流程的推文"),a("OutboundLink")],1)])]),e._v(" "),a("p",[a("a",{attrs:{"data-fancybox":"",title:"优先级如何决定更新的顺序",href:"/notes/assets/react/update-process.png"}},[a("img",{attrs:{src:"/notes/assets/react/update-process.png",alt:"优先级如何决定更新的顺序"}})])]),e._v(" "),a("p",[e._v("在这个例子中，有两个"),a("code",[e._v("Update")]),e._v("。将“关闭黑夜模式”产生的"),a("code",[e._v("Update")]),e._v("称为"),a("code",[e._v("u1")]),e._v("，输入字母“I”产生的"),a("code",[e._v("Update")]),e._v("称为"),a("code",[e._v("u2")]),e._v("。")]),e._v(" "),a("p",[e._v("其中"),a("code",[e._v("u1")]),e._v("先触发并进入"),a("code",[e._v("render阶段")]),e._v("。其优先级较低，执行时间较长。此时：")]),e._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[e._v("fiber"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("updateQueue "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  baseState"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    blackTheme"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[e._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    text"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'H'")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n  firstBaseUpdate"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n  lastBaseUpdate"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("null")]),e._v("\n  shared"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    pending"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" u1\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n  effects"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("null")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br"),a("span",{staticClass:"line-number"},[e._v("10")]),a("br"),a("span",{staticClass:"line-number"},[e._v("11")]),a("br"),a("span",{staticClass:"line-number"},[e._v("12")]),a("br")])]),a("p",[e._v("在"),a("code",[e._v("u1")]),e._v("完成"),a("code",[e._v("render阶段")]),e._v("前用户通过键盘输入字母“I”，产生了"),a("code",[e._v("u2")]),e._v("。"),a("code",[e._v("u2")]),e._v("属于"),a("strong",[e._v("受控的用户输入")]),e._v("，优先级高于"),a("code",[e._v("u1")]),e._v("，于是中断"),a("code",[e._v("u1")]),e._v("产生的"),a("code",[e._v("render阶段")]),e._v("。")]),e._v(" "),a("p",[e._v("此时：")]),e._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[e._v("fiber"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("updateQueue"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("shared"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("pending "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("===")]),e._v(" u2 "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" u1\n                                     "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("^")]),e._v("        "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n                                     "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("________"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// 即")]),e._v("\nu2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("next "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("===")]),e._v(" u1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\nu1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("next "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("===")]),e._v(" u2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br")])]),a("p",[e._v("其中"),a("code",[e._v("u2")]),e._v("优先级高于"),a("code",[e._v("u1")]),e._v("。")]),e._v(" "),a("p",[e._v("接下来进入"),a("code",[e._v("u2")]),e._v("产生的"),a("code",[e._v("render阶段")]),e._v("。")]),e._v(" "),a("p",[e._v("在"),a("code",[e._v("processUpdateQueue")]),e._v("方法中，"),a("code",[e._v("shared.pending")]),e._v("环状链表会被剪开并拼接在"),a("code",[e._v("baseUpdate")]),e._v("后面。")]),e._v(" "),a("p",[e._v("需要明确一点，"),a("code",[e._v("shared.pending")]),e._v("指向最后一个"),a("code",[e._v("pending")]),e._v("的"),a("code",[e._v("update")]),e._v("，所以实际执行时"),a("code",[e._v("update")]),e._v("的顺序为：")]),e._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[e._v("u1 "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),e._v(" u2\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("接下来遍历"),a("code",[e._v("baseUpdate")]),e._v("，处理优先级合适的"),a("code",[e._v("Update")]),e._v("（这一次处理的是更高优的"),a("code",[e._v("u2")]),e._v("）。")]),e._v(" "),a("p",[e._v("由于"),a("code",[e._v("u2")]),e._v("不是"),a("code",[e._v("baseUpdate")]),e._v("中的第一个"),a("code",[e._v("update")]),e._v("，在其之前的"),a("code",[e._v("u1")]),e._v("由于优先级不够被跳过。")]),e._v(" "),a("p",[a("code",[e._v("update")]),e._v("之间可能有依赖关系，所以被跳过的"),a("code",[e._v("update")]),e._v("及其后面所有"),a("code",[e._v("update")]),e._v("会成为下次更新的"),a("code",[e._v("baseUpdate")]),e._v("。（即"),a("code",[e._v("u1 -- u2")]),e._v("）。")]),e._v(" "),a("p",[e._v("最终"),a("code",[e._v("u2")]),e._v("完成"),a("code",[e._v("render - commit阶段")]),e._v("。")]),e._v(" "),a("p",[e._v("此时：")]),e._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[e._v("fiber"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("updateQueue "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  baseState"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    blackTheme"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[e._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    text"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'HI'")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n  firstBaseUpdate"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" u1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n  lastBaseUpdate"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" u2\n  shared"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    pending"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("null")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n  effects"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("null")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br"),a("span",{staticClass:"line-number"},[e._v("10")]),a("br"),a("span",{staticClass:"line-number"},[e._v("11")]),a("br"),a("span",{staticClass:"line-number"},[e._v("12")]),a("br")])]),a("p",[e._v("在"),a("code",[e._v("commit")]),e._v("阶段结尾会再调度一次更新。在该次更新中会基于"),a("code",[e._v("baseState")]),e._v("中"),a("code",[e._v("firstBaseUpdate")]),e._v("保存的"),a("code",[e._v("u1")]),e._v("，开启一次新的"),a("code",[e._v("render阶段")]),e._v("。")]),e._v(" "),a("p",[e._v("最终两次"),a("code",[e._v("Update")]),e._v("都完成后的结果如下：")]),e._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[e._v("fiber"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("updateQueue "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  baseState"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    blackTheme"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[e._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    text"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'HI'")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n  firstBaseUpdate"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n  lastBaseUpdate"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("null")]),e._v("\n  shared"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    pending"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("null")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n  effects"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("null")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br"),a("span",{staticClass:"line-number"},[e._v("10")]),a("br"),a("span",{staticClass:"line-number"},[e._v("11")]),a("br"),a("span",{staticClass:"line-number"},[e._v("12")]),a("br")])]),a("p",[e._v("可以看见，"),a("code",[e._v("u2")]),e._v("对应的更新执行了两次，相应的"),a("code",[e._v("render阶段")]),e._v("的生命周期勾子"),a("code",[e._v("componentWillXXX")]),e._v("也会触发两次。这也是为什么这些勾子会被标记为"),a("code",[e._v("unsafe_")]),e._v("。")]),e._v(" "),a("h2",{attrs:{id:"如何保证状态正确"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#如何保证状态正确"}},[e._v("#")]),e._v(" 如何保证状态正确")]),e._v(" "),a("p",[e._v("现在基本掌握了"),a("code",[e._v("updateQueue")]),e._v("的工作流程。还有两个疑问：")]),e._v(" "),a("ul",[a("li",[a("p",[a("code",[e._v("render阶段")]),e._v("可能被中断。如何保证"),a("code",[e._v("updateQueue")]),e._v("中保存的"),a("code",[e._v("Update")]),e._v("不丢失？")])]),e._v(" "),a("li",[a("p",[e._v("有时候当前"),a("code",[e._v("状态")]),e._v("需要依赖前一个"),a("code",[e._v("状态")]),e._v("。如何在支持跳过"),a("code",[e._v("低优先级状态")]),e._v("的同时保证"),a("strong",[e._v("状态依赖的连续性")]),e._v("？")])])]),e._v(" "),a("p",[e._v("分别讲解下。")]),e._v(" "),a("h3",{attrs:{id:"如何保证update不丢失"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#如何保证update不丢失"}},[e._v("#")]),e._v(" 如何保证"),a("code",[e._v("Update")]),e._v("不丢失")]),e._v(" "),a("p",[e._v("在"),a("RouterLink",{attrs:{to:"/react/state/update.html#例子"}},[e._v("上一节例子")]),e._v("中讲到，在"),a("code",[e._v("render阶段")]),e._v("，"),a("code",[e._v("shared.pending")]),e._v("的环被剪开并连接在"),a("code",[e._v("updateQueue.lastBaseUpdate")]),e._v("后面。")],1),e._v(" "),a("p",[e._v("实际上"),a("code",[e._v("shared.pending")]),e._v("会被同时连接在"),a("code",[e._v("workInProgress updateQueue.lastBaseUpdate")]),e._v("与"),a("code",[e._v("current updateQueue.lastBaseUpdate")]),e._v("后面。")]),e._v(" "),a("blockquote",[a("p",[e._v("具体代码见"),a("a",{attrs:{href:"https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactUpdateQueue.new.js#L424",target:"_blank",rel:"noopener noreferrer"}},[e._v("这里"),a("OutboundLink")],1)])]),e._v(" "),a("p",[e._v("当"),a("code",[e._v("render阶段")]),e._v("被中断后重新开始时，会基于"),a("code",[e._v("current updateQueue")]),e._v("克隆出"),a("code",[e._v("workInProgress updateQueue")]),e._v("。由于"),a("code",[e._v("current updateQueue.lastBaseUpdate")]),e._v("已经保存了上一次的"),a("code",[e._v("Update")]),e._v("，所以不会丢失。")]),e._v(" "),a("p",[e._v("当"),a("code",[e._v("commit阶段")]),e._v("完成渲染，由于"),a("code",[e._v("workInProgress updateQueue.lastBaseUpdate")]),e._v("中保存了上一次的"),a("code",[e._v("Update")]),e._v("，所以 "),a("code",[e._v("workInProgress Fiber树")]),e._v("变成"),a("code",[e._v("current Fiber树")]),e._v("后也不会造成"),a("code",[e._v("Update")]),e._v("丢失。")]),e._v(" "),a("h3",{attrs:{id:"如何保证状态依赖的连续性"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#如何保证状态依赖的连续性"}},[e._v("#")]),e._v(" 如何保证状态依赖的连续性")]),e._v(" "),a("p",[e._v("当某个"),a("code",[e._v("Update")]),e._v("由于优先级低而被跳过时，保存在"),a("code",[e._v("baseUpdate")]),e._v("中的不仅是该"),a("code",[e._v("Update")]),e._v("，还包括链表中该"),a("code",[e._v("Update")]),e._v("之后的所有"),a("code",[e._v("Update")]),e._v("。")]),e._v(" "),a("p",[e._v("考虑如下例子：")]),e._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[e._v("baseState"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("''")]),e._v("\nshared"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("pending"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[e._v("A1")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[e._v("B2")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[e._v("C1")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[e._v("D2")]),e._v("\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("p",[e._v("其中"),a("code",[e._v("字母")]),e._v("代表该"),a("code",[e._v("Update")]),e._v("要在页面插入的字母，"),a("code",[e._v("数字")]),e._v("代表"),a("code",[e._v("优先级")]),e._v("，值越低"),a("code",[e._v("优先级")]),e._v("越高。")]),e._v(" "),a("p",[e._v("第一次"),a("code",[e._v("render")]),e._v("，"),a("code",[e._v("优先级")]),e._v("为1。")]),e._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[e._v("baseState"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("''")]),e._v("\nbaseUpdate"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("null")]),e._v("\nrender阶段使用的Update"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),a("span",{pre:!0,attrs:{class:"token constant"}},[e._v("A1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[e._v("C1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\nmemoizedState"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'AC'")]),e._v("\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br")])]),a("p",[e._v("其中"),a("code",[e._v("B2")]),e._v("由于优先级为2，低于当前优先级，所以他及其后面的所有"),a("code",[e._v("Update")]),e._v("会被保存在"),a("code",[e._v("baseUpdate")]),e._v("中作为下次更新的"),a("code",[e._v("Update")]),e._v("（即"),a("code",[e._v("B2 C1 D2")]),e._v("）。")]),e._v(" "),a("p",[e._v("这么做是为了保持"),a("code",[e._v("状态")]),e._v("的前后依赖顺序。")]),e._v(" "),a("p",[e._v("第二次"),a("code",[e._v("render")]),e._v("，"),a("code",[e._v("优先级")]),e._v("为2。")]),e._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[e._v("baseState"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'A'")]),e._v("\nbaseUpdate"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[e._v("B2")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[e._v("C1")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[e._v("D2")]),e._v("\nrender阶段使用的Update"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),a("span",{pre:!0,attrs:{class:"token constant"}},[e._v("B2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[e._v("C1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[e._v("D2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\nmemoizedState"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'ABCD'")]),e._v("\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br")])]),a("p",[e._v("注意这里"),a("code",[e._v("baseState")]),e._v("并不是上一次更新的"),a("code",[e._v("memoizedState")]),e._v("。这是由于"),a("code",[e._v("B2")]),e._v("被跳过了。")]),e._v(" "),a("p",[e._v("即当有"),a("code",[e._v("Update")]),e._v("被跳过时，"),a("code",[e._v("下次更新的baseState !== 上次更新的memoizedState")]),e._v("。")]),e._v(" "),a("blockquote",[a("p",[e._v("跳过"),a("code",[e._v("B2")]),e._v("的逻辑见"),a("a",{attrs:{href:"https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactUpdateQueue.new.js#L479",target:"_blank",rel:"noopener noreferrer"}},[e._v("这里"),a("OutboundLink")],1)])]),e._v(" "),a("p",[e._v("通过以上例子可以发现，"),a("code",[e._v("React")]),e._v("保证最终的状态一定和用户触发的"),a("code",[e._v("交互")]),e._v("一致，但是中间过程"),a("code",[e._v("状态")]),e._v("可能由于设备不同而不同。")]),e._v(" "),a("p",[e._v("details 高优先级任务打断低优先级任务Demo")]),e._v(" "),a("p",[a("a",{attrs:{href:"https://codesandbox.io/s/epic-borg-kx7jn",target:"_blank",rel:"noopener noreferrer"}},[e._v("多重异步更改"),a("OutboundLink")],1)]),e._v(" "),a("h2",{attrs:{id:"参考资料"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[e._v("#")]),e._v(" 参考资料")]),e._v(" "),a("p",[a("a",{attrs:{href:"https://juejin.im/post/5f05a3e25188252e5c576cdb",target:"_blank",rel:"noopener noreferrer"}},[e._v("深入源码剖析componentWillXXX为什么UNSAFE"),a("OutboundLink")],1)]),e._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactUpdateQueue.new.js#L10",target:"_blank",rel:"noopener noreferrer"}},[e._v("React源码中讲解Update工作流程及优先级的注释"),a("OutboundLink")],1)]),e._v(" "),a("p",[a("a",{attrs:{href:"https://twitter.com/acdlite/status/978412930973687808",target:"_blank",rel:"noopener noreferrer"}},[e._v("React Core Team Andrew向网友讲解Update工作流程的推文"),a("OutboundLink")],1)])])}),[],!1,null,null,null);t.default=r.exports}}]);