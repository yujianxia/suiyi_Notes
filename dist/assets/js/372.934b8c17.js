(window.webpackJsonp=window.webpackJsonp||[]).push([[372],{732:function(s,t,e){"use strict";e.r(t);var a=e(25),n=Object(a.a)({},(function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("p",[s._v("上一节了解到"),e("code",[s._v("render阶段")]),s._v("的工作可以分为“递”阶段和“归”阶段。其中“递”阶段会执行"),e("code",[s._v("beginWork")]),s._v("，“归”阶段会执行"),e("code",[s._v("completeWork")]),s._v("。这一节看看“递”阶段的"),e("code",[s._v("beginWork")]),s._v("方法究竟做了什么。")]),s._v(" "),e("h2",{attrs:{id:"方法概览"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#方法概览"}},[s._v("#")]),s._v(" 方法概览")]),s._v(" "),e("p",[s._v("可以从"),e("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberBeginWork.new.js#L3075",target:"_blank",rel:"noopener noreferrer"}},[s._v("源码这里"),e("OutboundLink")],1),s._v("看到"),e("code",[s._v("beginWork")]),s._v("的定义。整个方法大概有500行代码。")]),s._v(" "),e("p",[s._v("从上一节已经知道，"),e("code",[s._v("beginWork")]),s._v("的工作是传入"),e("code",[s._v("当前Fiber节点")]),s._v("，创建"),e("code",[s._v("子Fiber节点")]),s._v("，从传参来看看具体是如何做的。")]),s._v(" "),e("h3",{attrs:{id:"从传参看方法执行"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#从传参看方法执行"}},[s._v("#")]),s._v(" 从传参看方法执行")]),s._v(" "),e("div",{staticClass:"language-js line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("beginWork")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("current"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Fiber "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  workInProgress"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Fiber"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  renderLanes"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lanes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Fiber "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略函数体")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("其中传参：")]),s._v(" "),e("ul",[e("li",[s._v("current：当前组件对应的"),e("code",[s._v("Fiber节点")]),s._v("在上一次更新时的"),e("code",[s._v("Fiber节点")]),s._v("，即"),e("code",[s._v("workInProgress.alternate")])]),s._v(" "),e("li",[s._v("workInProgress：当前组件对应的"),e("code",[s._v("Fiber节点")])]),s._v(" "),e("li",[s._v("renderLanes：优先级相关，在讲解"),e("code",[s._v("Scheduler")]),s._v("时再讲解")])]),s._v(" "),e("p",[s._v("从"),e("RouterLink",{attrs:{to:"/react/process/doubleBuffer.html"}},[s._v("双缓存机制一节")]),s._v("知道，除"),e("RouterLink",{attrs:{to:"/react/process/doubleBuffer.html#mount时"}},[e("code",[s._v("rootFiber")])]),s._v("以外， 组件"),e("code",[s._v("mount")]),s._v("时，由于是首次渲染，是不存在当前组件对应的"),e("code",[s._v("Fiber节点")]),s._v("在上一次更新时的"),e("code",[s._v("Fiber节点")]),s._v("，即"),e("code",[s._v("mount")]),s._v("时"),e("code",[s._v("current === null")]),s._v("。")],1),s._v(" "),e("p",[s._v("组件"),e("code",[s._v("update")]),s._v("时，由于之前已经"),e("code",[s._v("mount")]),s._v("过，所以"),e("code",[s._v("current !== null")]),s._v("。")]),s._v(" "),e("p",[s._v("所以可以通过"),e("code",[s._v("current === null ?")]),s._v("来区分组件是处于"),e("code",[s._v("mount")]),s._v("还是"),e("code",[s._v("update")]),s._v("。")]),s._v(" "),e("p",[s._v("基于此原因，"),e("code",[s._v("beginWork")]),s._v("的工作可以分为两部分：")]),s._v(" "),e("ul",[e("li",[e("p",[e("code",[s._v("update")]),s._v("时：如果"),e("code",[s._v("current")]),s._v("存在，在满足一定条件时可以复用"),e("code",[s._v("current")]),s._v("节点，这样就能克隆"),e("code",[s._v("current.child")]),s._v("作为"),e("code",[s._v("workInProgress.child")]),s._v("，而不需要新建"),e("code",[s._v("workInProgress.child")]),s._v("。")])]),s._v(" "),e("li",[e("p",[e("code",[s._v("mount")]),s._v("时：除"),e("code",[s._v("fiberRootNode")]),s._v("以外，"),e("code",[s._v("current === null")]),s._v("。会根据"),e("code",[s._v("fiber.tag")]),s._v("不同，创建不同类型的"),e("code",[s._v("子Fiber节点")])])])]),s._v(" "),e("div",{staticClass:"language-js line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("beginWork")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("current"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Fiber "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  workInProgress"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Fiber"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  renderLanes"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lanes")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Fiber "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// update时：如果current存在可能存在优化路径，可以复用current（即上一次更新的Fiber节点）")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("current "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!==")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略")]),s._v("\n\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 复用current")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("bailoutOnAlreadyFinishedWork")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n      current"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      workInProgress"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      renderLanes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    didReceiveUpdate "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// mount时：根据tag不同，创建不同的子Fiber节点")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("switch")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("workInProgress"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("tag"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" IndeterminateComponent"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" \n      "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" LazyComponent"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" \n      "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" FunctionComponent"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" \n      "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" ClassComponent"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" \n      "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" HostRoot"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" HostComponent"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" HostText"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略其他类型")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br")])]),e("h2",{attrs:{id:"update时"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#update时"}},[s._v("#")]),s._v(" update时")]),s._v(" "),e("p",[s._v("可以看到，满足如下情况时"),e("code",[s._v("didReceiveUpdate === false")]),s._v("（即可以直接复用前一次更新的"),e("code",[s._v("子Fiber")]),s._v("，不需要新建"),e("code",[s._v("子Fiber")]),s._v("）")]),s._v(" "),e("ol",[e("li",[e("code",[s._v("oldProps === newProps && workInProgress.type === current.type")]),s._v("，即"),e("code",[s._v("props")]),s._v("与"),e("code",[s._v("fiber.type")]),s._v("不变")]),s._v(" "),e("li",[e("code",[s._v("!includesSomeLane(renderLanes, updateLanes)")]),s._v("，即当前"),e("code",[s._v("Fiber节点")]),s._v("优先级不够，会在讲解"),e("code",[s._v("Scheduler")]),s._v("时介绍")])]),s._v(" "),e("div",{staticClass:"language-js line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("current "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!==")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" oldProps "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" current"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("memoizedProps"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" newProps "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" workInProgress"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pendingProps"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n      oldProps "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!==")]),s._v(" newProps "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("hasLegacyContextChanged")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("__DEV__ "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("?")]),s._v(" workInProgress"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("type "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!==")]),s._v(" current"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("type "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      didReceiveUpdate "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("includesSomeLane")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("renderLanes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" updateLanes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      didReceiveUpdate "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("switch")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("workInProgress"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("tag"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 省略处理")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("bailoutOnAlreadyFinishedWork")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n        current"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        workInProgress"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        renderLanes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      didReceiveUpdate "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    didReceiveUpdate "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br")])]),e("h2",{attrs:{id:"mount时"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#mount时"}},[s._v("#")]),s._v(" mount时")]),s._v(" "),e("p",[s._v("当不满足优化路径时，就进入第二部分，新建"),e("code",[s._v("子Fiber")]),s._v("。")]),s._v(" "),e("p",[s._v("可以看到，根据"),e("code",[s._v("fiber.tag")]),s._v("不同，进入不同类型"),e("code",[s._v("Fiber")]),s._v("的创建逻辑。")]),s._v(" "),e("blockquote",[e("p",[s._v("可以从"),e("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactWorkTags.js",target:"_blank",rel:"noopener noreferrer"}},[s._v("这里"),e("OutboundLink")],1),s._v("看到"),e("code",[s._v("tag")]),s._v("对应的组件类型")])]),s._v(" "),e("div",{staticClass:"language-js line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// mount时：根据tag不同，创建不同的Fiber节点")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("switch")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("workInProgress"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("tag"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" IndeterminateComponent"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" \n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" LazyComponent"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" \n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" FunctionComponent"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" \n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" ClassComponent"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" \n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" HostRoot"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" HostComponent"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" HostText"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略其他类型")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br")])]),e("p",[s._v("对于常见的组件类型，如（"),e("code",[s._v("FunctionComponent")]),s._v("/"),e("code",[s._v("ClassComponent")]),s._v("/"),e("code",[s._v("HostComponent")]),s._v("），最终会进入"),e("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberBeginWork.new.js#L233",target:"_blank",rel:"noopener noreferrer"}},[s._v("reconcileChildren"),e("OutboundLink")],1),s._v("方法。")]),s._v(" "),e("h2",{attrs:{id:"reconcilechildren"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#reconcilechildren"}},[s._v("#")]),s._v(" reconcileChildren")]),s._v(" "),e("p",[s._v("从该函数名就能看出这是"),e("code",[s._v("Reconciler")]),s._v("模块的核心部分。那么他究竟做了什么呢？")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("对于"),e("code",[s._v("mount")]),s._v("的组件，他会创建新的"),e("code",[s._v("子Fiber节点")])])]),s._v(" "),e("li",[e("p",[s._v("对于"),e("code",[s._v("update")]),s._v("的组件，他会将当前组件与该组件在上次更新时对应的"),e("code",[s._v("Fiber节点")]),s._v("比较（也就是俗称的"),e("code",[s._v("Diff")]),s._v("算法），将比较的结果生成新"),e("code",[s._v("Fiber节点")])])])]),s._v(" "),e("div",{staticClass:"language-js line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("reconcileChildren")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("current"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Fiber "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  workInProgress"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Fiber"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  nextChildren"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" any"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  renderLanes"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lanes")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("current "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("===")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 对于mount的组件")]),s._v("\n    workInProgress"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("child "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mountChildFibers")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n      workInProgress"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      nextChildren"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      renderLanes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 对于update的组件")]),s._v("\n    workInProgress"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("child "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("reconcileChildFibers")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n      workInProgress"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      current"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("child"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      nextChildren"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      renderLanes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br")])]),e("p",[s._v("从代码可以看出，和"),e("code",[s._v("beginWork")]),s._v("一样，他也是通过"),e("code",[s._v("current === null ?")]),s._v("区分"),e("code",[s._v("mount")]),s._v("与"),e("code",[s._v("update")]),s._v("。")]),s._v(" "),e("p",[s._v("不论走哪个逻辑，最终他会生成新的子"),e("code",[s._v("Fiber节点")]),s._v("并赋值给"),e("code",[s._v("workInProgress.child")]),s._v("，作为本次"),e("code",[s._v("beginWork")]),e("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberBeginWork.new.js#L1158",target:"_blank",rel:"noopener noreferrer"}},[s._v("返回值"),e("OutboundLink")],1),s._v("，并作为下次"),e("code",[s._v("performUnitOfWork")]),s._v("执行时"),e("code",[s._v("workInProgress")]),s._v("的"),e("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L1702",target:"_blank",rel:"noopener noreferrer"}},[s._v("传参"),e("OutboundLink")],1),s._v("。")]),s._v(" "),e("p",[s._v("warning 注意\n值得一提的是，"),e("code",[s._v("mountChildFibers")]),s._v("与"),e("code",[s._v("reconcileChildFibers")]),s._v("这两个方法的逻辑基本一致。唯一的区别是："),e("code",[s._v("reconcileChildFibers")]),s._v("会为生成的"),e("code",[s._v("Fiber节点")]),s._v("带上"),e("code",[s._v("effectTag")]),s._v("属性，而"),e("code",[s._v("mountChildFibers")]),s._v("不会。")]),s._v(" "),e("h2",{attrs:{id:"effecttag"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#effecttag"}},[s._v("#")]),s._v(" effectTag")]),s._v(" "),e("p",[s._v("知道，"),e("code",[s._v("render阶段")]),s._v("的工作是在内存中进行，当工作结束后会通知"),e("code",[s._v("Renderer")]),s._v("需要执行的"),e("code",[s._v("DOM")]),s._v("操作。要执行"),e("code",[s._v("DOM")]),s._v("操作的具体类型就保存在"),e("code",[s._v("fiber.effectTag")]),s._v("中。")]),s._v(" "),e("blockquote",[e("p",[s._v("你可以从"),e("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactSideEffectTags.js",target:"_blank",rel:"noopener noreferrer"}},[s._v("这里"),e("OutboundLink")],1),s._v("看到"),e("code",[s._v("effectTag")]),s._v("对应的"),e("code",[s._v("DOM")]),s._v("操作")])]),s._v(" "),e("p",[s._v("比如：")]),s._v(" "),e("div",{staticClass:"language-js line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// DOM需要插入到页面中")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" Placement "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*                */")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0b00000000000010")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// DOM需要更新")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" Update "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*                   */")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0b00000000000100")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// DOM需要插入到页面中并更新")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" PlacementAndUpdate "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*       */")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0b00000000000110")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// DOM需要删除")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" Deletion "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*                 */")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0b00000000001000")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("blockquote",[e("p",[s._v("通过二进制表示"),e("code",[s._v("effectTag")]),s._v("，可以方便的使用位操作为"),e("code",[s._v("fiber.effectTag")]),s._v("赋值多个"),e("code",[s._v("effect")]),s._v("。")])]),s._v(" "),e("p",[s._v("那么，如果要通知"),e("code",[s._v("Renderer")]),s._v("将"),e("code",[s._v("Fiber节点")]),s._v("对应的"),e("code",[s._v("DOM节点")]),s._v("插入页面中，需要满足两个条件：")]),s._v(" "),e("ol",[e("li",[e("p",[e("code",[s._v("fiber.stateNode")]),s._v("存在，即"),e("code",[s._v("Fiber节点")]),s._v("中保存了对应的"),e("code",[s._v("DOM节点")])])]),s._v(" "),e("li",[e("p",[e("code",[s._v("(fiber.effectTag & Placement) !== 0")]),s._v("，即"),e("code",[s._v("Fiber节点")]),s._v("存在"),e("code",[s._v("Placement effectTag")])])])]),s._v(" "),e("p",[s._v("知道，"),e("code",[s._v("mount")]),s._v("时，"),e("code",[s._v("fiber.stateNode === null")]),s._v("，且在"),e("code",[s._v("reconcileChildren")]),s._v("中调用的"),e("code",[s._v("mountChildFibers")]),s._v("不会为"),e("code",[s._v("Fiber节点")]),s._v("赋值"),e("code",[s._v("effectTag")]),s._v("。那么首屏渲染如何完成呢？")]),s._v(" "),e("p",[s._v("针对第一个问题，"),e("code",[s._v("fiber.stateNode")]),s._v("会在"),e("code",[s._v("completeWork")]),s._v("中创建，会在下一节介绍。")]),s._v(" "),e("p",[s._v("第二个问题的答案十分巧妙：假设"),e("code",[s._v("mountChildFibers")]),s._v("也会赋值"),e("code",[s._v("effectTag")]),s._v("，那么可以预见"),e("code",[s._v("mount")]),s._v("时整棵"),e("code",[s._v("Fiber树")]),s._v("所有节点都会有"),e("code",[s._v("Placement effectTag")]),s._v("。那么"),e("code",[s._v("commit阶段")]),s._v("在执行"),e("code",[s._v("DOM")]),s._v("操作时每个节点都会执行一次插入操作，这样大量的"),e("code",[s._v("DOM")]),s._v("操作是极低效的。")]),s._v(" "),e("p",[s._v("为了解决这个问题，在"),e("code",[s._v("mount")]),s._v("时只有"),e("code",[s._v("rootFiber")]),s._v("会赋值"),e("code",[s._v("Placement effectTag")]),s._v("，在"),e("code",[s._v("commit阶段")]),s._v("只会执行一次插入操作。")]),s._v(" "),e("p",[s._v("details 根Fiber节点 Demo\n借用上一节的Demo，第一个进入"),e("code",[s._v("beginWork")]),s._v("方法的"),e("code",[s._v("Fiber节点")]),s._v("就是"),e("code",[s._v("rootFiber")]),s._v("，他的"),e("code",[s._v("alternate")]),s._v("指向"),e("code",[s._v("current rootFiber")]),s._v("（即他存在"),e("code",[s._v("current")]),s._v("）。")]),s._v(" "),e("blockquote",[e("p",[s._v("为什么"),e("code",[s._v("rootFiber")]),s._v("节点存在"),e("code",[s._v("current")]),s._v("（即"),e("code",[s._v("rootFiber.alternate")]),s._v("），在"),e("RouterLink",{attrs:{to:"/react/process/doubleBuffer.html"}},[s._v("双缓存机制一节mount时的第二步")]),s._v("已经讲过")],1)]),s._v(" "),e("p",[s._v("由于存在"),e("code",[s._v("current")]),s._v("，"),e("code",[s._v("rootFiber")]),s._v("在"),e("code",[s._v("reconcileChildren")]),s._v("时会走"),e("code",[s._v("reconcileChildFibers")]),s._v("逻辑。")]),s._v(" "),e("p",[s._v("而之后通过"),e("code",[s._v("beginWork")]),s._v("创建的"),e("code",[s._v("Fiber节点")]),s._v("是不存在"),e("code",[s._v("current")]),s._v("的（即 "),e("code",[s._v("fiber.alternate === null")]),s._v("），会走"),e("code",[s._v("mountChildFibers")]),s._v("逻辑")]),s._v(" "),e("p",[e("a",{attrs:{href:"https://codesandbox.io/s/fiber-root-hxvml",target:"_blank",rel:"noopener noreferrer"}},[s._v("执行流程"),e("OutboundLink")],1)]),s._v(" "),e("h2",{attrs:{id:"参考资料"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[s._v("#")]),s._v(" 参考资料")]),s._v(" "),e("p",[e("code",[s._v("beginWork")]),s._v("流程图")]),s._v(" "),e("p",[e("a",{attrs:{"data-fancybox":"",title:"beginWork流程图",href:"/notes/assets/react/beginWork.png"}},[e("img",{attrs:{src:"/notes/assets/react/beginWork.png",alt:"beginWork流程图"}})])])])}),[],!1,null,null,null);t.default=n.exports}}]);